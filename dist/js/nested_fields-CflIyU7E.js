jQuery(document).ready(function(){var b=jQuery("body");jQuery(document).bind("nestedfieldsinit",function(v){var u=jQuery(v.target);u.is(".nested")||(u=u.find(".nested")),u.each(function(){var d=jQuery(this),p=d.find(".list").first(),l=d.attr("data-name"),y='.item[data-name="'+l+'"]',h='.item[data-name="'+l+'"].new',x='.item[data-name="'+l+'"]:not(.new)';d.click(function(f,a){var r=jQuery(f.target);if(r.is("button")||(r=r.parents("button").first()),!(!r.is("button.add-nested-item")&&!r.is("button.remove-nested-item"))&&!r.prop("disabled")){var e=r.parents(".nested").first();if(e.attr("data-name")===l)if(r.is(".add-nested-item")){var n=null;if(e.is(".polymorphic")){var t=e.find("footer select.template-types");n=jQuery(t.find("option:selected").data("template"))}else n=jQuery(e.data("arbory-template"));d.trigger("nestedfieldscreate",{target_block:e,original_params:a,template:n})}else r.is(".remove-nested-item")&&d.trigger("nestedfieldsremove",{target_block:e,item:r.parents(y).first(),original_params:a})}}),d.on("nestedfieldscreate",function(f,a){var r=a.target_block,e=a.original_params,n=a.template;if(r.attr("data-name")===l){if(n.length!==1)return null;var t=n;t.addClass("new"),t.appendTo(p),t.trigger("nestedfieldsreindex",e),e&&e.no_animation?(t.trigger("nestedfieldsitemadd",e),t.trigger("contentloaded",e)):t.is("tr, td")?(t.css({opacity:1}).hide(),t.fadeIn("normal",function(){t.trigger("nestedfieldsitemadd",e),t.trigger("contentloaded",e)})):(t.css({opacity:0}),t.slideDown("fast",function(){t.css({opacity:1}).hide(),t.fadeIn("fast",function(){t.trigger("nestedfieldsitemadd",e),t.trigger("contentloaded",e)})}))}}),d.on("nestedfieldsremove",function(f,a){var r=a.target_block,e=a.item,n=a.original_params;if(r.attr("data-name")===l){var t=function(i){i.trigger("contentbeforeremove",n);var s=i.parent(),o=i.find("input.destroy");o.length>0?(o.val(!0),i.hide()):i.remove(),r.trigger("nestedfieldsreindex",n),s.trigger("contentremoved",n)};e.addClass("removed"),e.trigger("nestedfieldsitemremove",n),n&&n.no_animation?t(e):e.fadeOut("fast",function(){e.is("tr,td")?t(e):e.css({opacity:0}).show().slideUp("fast",function(){t(e)})})}}),d.on("nestedfieldsreindex",function(){var f=0,a=d.find(x);a.each(function(){var i=jQuery(this).attr("data-index");typeof i>"u"||(i=i*1,i>=f&&(f=i+1))});var r=d.find(h),e=f,n=[];r.each(function(){var i=jQuery(this);i.attr("data-index",e);var s=new RegExp("(\\[|_)"+l+"(\\]\\[|_)(\\d*|_template_)?(\\]|_)"),o=new RegExp("((\\[|_)"+l+"(\\]\\[|_))(\\d*|_template_)?(\\]|_)","g"),j="$1"+e+"$5",m=["name","id","for"];i.find("input,select,textarea,button,label").each(function(){for(var c=0;c<m.length;c++){var g=jQuery(this).attr(m[c]);if(g&&g.match(s)){var _={element:this,attribute:m[c],old_value:g,new_value:g.replace(o,j)};if(_.old_value===_.new_value)continue;n.push(_)}}}),e++});var t="nestedfieldsreindex_temporary_value_";jQuery.each(n,function(i,s){var o=jQuery(s.element);o.trigger("beforeattributechange",s),o.attr(s.attribute,t+i)}),jQuery.each(n,function(i,s){var o=jQuery(s.element);o.attr(s.attribute,s.new_value),o.trigger("attributechanged",s)})}),d.on("sortableupdate",function(){d.trigger("nestedfieldsreindex")}),d.on("nestedfieldsitemadd",function(f){var a=jQuery(f.target);a.attr("data-name")===l&&a.find("input, select, textarea").filter(":visible").first().focus()})})}),b.on("contentloaded",function(v,u){jQuery(v.target).trigger("nestedfieldsinit",u)})});
